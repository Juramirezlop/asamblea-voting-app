<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Votaci√≥n para Asambleas</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üó≥Ô∏è</text></svg>">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #48bb78;
            --danger-color: #f56565;
            --warning-color: #ed8936;
            --info-color: #4299e1;
            --dark-color: #2d3748;
            --gray-100: #f7fafc;
            --gray-200: #edf2f7;
            --gray-300: #e2e8f0;
            --gray-500: #a0aec0;
            --gray-700: #4a5568;
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--dark-color);
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: var(--shadow-xl);
            padding: 2.5rem;
            width: 90%;
            max-width: 1000px;
            position: relative;
            min-height: 600px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--success-color));
            background-size: 200% 100%;
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 2.5rem;
            padding-bottom: 2rem;
            position: relative;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 2px;
            transform: translateX(-50%);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .header h1 {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }

        .header p {
            color: var(--gray-700);
            font-size: 1.1rem;
            font-weight: 500;
            opacity: 0.8;
        }

        .login-section {
            text-align: center;
            padding: 2rem 0;
        }

        .code-input {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid var(--gray-300);
            border-radius: 16px;
            padding: 1.25rem 1.75rem;
            font-size: 1.2rem;
            text-align: center;
            width: 100%;
            max-width: 320px;
            margin: 1.5rem auto;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
            color: var(--dark-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: block;
        }

        .code-input:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.25);
        }

        .code-input::placeholder {
            color: var(--gray-500);
            font-weight: 400;
            letter-spacing: 1px;
        }

        .tabs-container {
            display: flex;
            border-bottom: 2px solid var(--gray-200);
            margin-bottom: 2rem;
            gap: 0;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 16px 16px 0 0;
            overflow: hidden;
        }

        .tab-button {
            flex: 1;
            padding: 1.2rem 2rem;
            background: rgba(255, 255, 255, 0.3);
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-700);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .tab-button::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transform: scaleX(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-button:hover {
            background: rgba(255, 255, 255, 0.7);
            color: var(--dark-color);
            transform: translateY(-2px);
        }

        .tab-button.active {
            background: rgba(255, 255, 255, 0.95);
            color: var(--primary-color);
            font-weight: 700;
        }

        .tab-button.active::before {
            transform: scaleX(1);
        }

        .tab-content {
            display: none;
            animation: fadeInUp 0.4s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 0.75rem;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:active {
            transform: translateY(-1px);
            transition: transform 0.1s;
        }

        .btn:disabled {
            background: linear-gradient(135deg, var(--gray-500), var(--gray-500));
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .btn-admin {
            background: linear-gradient(135deg, var(--gray-700), #2d3748);
            font-size: 0.95rem;
            padding: 1rem 2rem;
            margin: 1.5rem auto;
            display: block;
            border-radius: 50px;
        }

        .btn-admin:hover {
            box-shadow: 0 10px 40px rgba(74, 85, 104, 0.4);
        }

        .btn-large {
            padding: 1.25rem 3rem;
            font-size: 1.1rem;
            margin: 1rem;
            min-width: 200px;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #e53e3e);
        }

        .btn-danger:hover {
            box-shadow: 0 10px 40px rgba(245, 101, 101, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #38a169);
        }

        .btn-success:hover {
            box-shadow: 0 10px 40px rgba(72, 187, 120, 0.4);
        }

        .hidden {
            display: none !important;
        }

        .admin-panel, .voting-section, .card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            margin: 1.5rem 0;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .admin-panel:hover, .voting-section:hover, .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .admin-panel h3, .voting-section h3, .voting-section h4 {
            color: var(--dark-color);
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .question-form {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 249, 250, 0.9));
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 2.5rem;
            margin: 1.5rem auto;
            box-shadow: var(--shadow-lg);
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .question-form:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .question-form input, .question-form select, .question-form textarea {
            width: 100%;
            padding: 1.2rem;
            margin: 0.8rem 0;
            border: 2px solid var(--gray-300);
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.9);
            text-align: left;
        }

        .question-form input:focus, .question-form select:focus, .question-form textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .multiple-selection-panel {
            background: rgba(248, 249, 250, 0.8);
            border: 1px solid var(--gray-300);
            border-radius: 16px;
            padding: 2rem;
            margin-top: 2rem;
            backdrop-filter: blur(5px);
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .checkbox-container:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .candidates-input {
            min-height: 120px;
            resize: vertical;
        }

        .vote-option {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid var(--gray-300);
            border-radius: 16px;
            padding: 1.25rem;
            margin: 1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1.1rem;
            font-weight: 500;
            text-align: center;
            display: inline-block;
            min-width: 140px;
            position: relative;
            overflow: hidden;
        }

        .vote-option::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .vote-option:hover {
            transform: translateY(-2px) scale(1.02);
            border-color: var(--primary-color);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
        }

        .vote-option:hover::before {
            width: 300px;
            height: 300px;
        }

        .vote-option.selected {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-color: var(--primary-color);
            color: white;
            transform: translateY(-2px) scale(1.02);
        }

        .vote-option.yes-option {
            background: linear-gradient(135deg, rgba(72, 187, 120, 0.1), rgba(56, 161, 105, 0.1));
            border-color: var(--success-color);
            color: #2f855a;
        }

        .vote-option.yes-option:hover {
            background: linear-gradient(135deg, var(--success-color), #38a169);
            color: white;
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.3);
        }

        .vote-option.no-option {
            background: linear-gradient(135deg, rgba(245, 101, 101, 0.1), rgba(229, 62, 62, 0.1));
            border-color: var(--danger-color);
            color: #c53030;
        }

        .vote-option.no-option:hover {
            background: linear-gradient(135deg, var(--danger-color), #e53e3e);
            color: white;
            box-shadow: 0 8px 25px rgba(245, 101, 101, 0.3);
        }

        .results-panel {
            background: linear-gradient(135deg, rgba(241, 248, 233, 0.9), rgba(200, 230, 201, 0.9));
            border: 1px solid var(--success-color);
            border-radius: 16px;
            padding: 2rem;
            margin: 1.5rem 0;
            backdrop-filter: blur(10px);
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin: 0.8rem 0;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            min-height: 60px;
            transition: all 0.3s ease;
        }

        .result-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .result-item span {
            white-space: nowrap; 
            min-width: fit-content;
        }

        .result-item span:first-child {
            flex: 0 0 auto;
            margin-right: 1rem;
            font-weight: 600;
        }

        .result-item span:last-child {
            flex: 0 0 auto;
            text-align: right;
            margin-left: 1rem;
            font-weight: 600;
        }

        .progress-bar {
            width: 200px;
            height: 8px;
            background: var(--gray-200);
            border-radius: 10px;
            overflow: hidden;
            margin: 0 1rem;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            border-radius: 10px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            animation: shimmer-progress 2s infinite;
        }

        @keyframes shimmer-progress {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .status-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 1.2rem 1.5rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.3);
            min-width: 280px;
            font-size: 0.95rem;
            z-index: 1000;
            transform: translateX(400px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .status-panel:not(.hidden) {
            transform: translateX(0);
        }

        .voter-info {
            background: linear-gradient(135deg, rgba(232, 244, 253, 0.9), rgba(190, 229, 235, 0.9));
            border: 1px solid var(--info-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .logout-btn {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: linear-gradient(135deg, var(--danger-color), #e53e3e);
            color: white;
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 101, 101, 0.4);
        }

        .admin-login-container {
            background: rgba(248, 249, 250, 0.9);
            border: 1px solid var(--gray-300);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1.5rem auto;
            max-width: 320px;
            backdrop-filter: blur(10px);
            animation: fadeInUp 0.4s ease-out;
        }

        .admin-login-container input {
            font-size: 0.95rem;
            padding: 0.8rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-number {
            font-size: 2.2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .stat-label {
            color: var(--gray-700);
            font-size: 0.9rem;
            font-weight: 500;
            opacity: 0.8;
        }

        .attendance-info {
            margin-top: 0.8rem;
            font-size: 0.95rem;
            color: var(--success-color);
            font-weight: 600;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--gray-700);
        }

        .loading::before {
            content: '';
            width: 40px;
            height: 40px;
            border: 4px solid var(--gray-300);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            margin-right: 1rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .file-upload {
            border: 2px dashed var(--gray-300);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            margin: 1.5rem 0;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(5px);
        }

        .file-upload:hover {
            border-color: var(--primary-color);
            background: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
        }

        .file-upload input[type="file"] {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                width: 95%;
                padding: 1.5rem;
                border-radius: 20px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .result-item {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            
            .progress-bar {
                margin: 0.5rem 0;
                width: 100%;
            }

            .btn-large {
                min-width: auto;
                width: 100%;
                margin: 0.5rem 0;
            }
            
            .vote-option {
                display: block;
                margin: 0.5rem 0;
                width: calc(100% - 2rem);
            }

            .tabs-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="logout-btn hidden" onclick="logout()">Salir</button>
        
        <!-- Pantalla de Bienvenida -->
        <div id="welcome-screen">
            <div class="header">
                <h1>Sistema de Votaci√≥n Electr√≥nica</h1>
                <p>Asamblea General</p>
            </div>
            
            <div class="login-section">
                <h3>Ingrese su c√≥digo de acceso:</h3>
                <p style="color: var(--gray-700); font-size: 0.9rem; margin-bottom: 1rem;">
                    Formato: Torre-Apartamento (ejemplo: 1-201, 2-1503)
                </p>
                <input type="text" class="code-input" id="access-code" placeholder="1-201" maxlength="10">
                <br>
                <button class="btn btn-large btn-success" onclick="registerAttendance()">Solo Asistencia</button>
                <button class="btn btn-large" onclick="accessVoting()">Votaciones</button>
                <br>
                <button class="btn btn-admin" onclick="showAdminLogin()">Acceso Administrador</button>
            </div>
            
            <div id="admin-login" class="admin-login-container hidden">
                <input type="text" class="code-input" id="admin-username" placeholder="Usuario" style="max-width: 100%; font-size: 0.9rem;">
                <input type="password" class="code-input" id="admin-password" placeholder="Contrase√±a" style="max-width: 100%; font-size: 0.9rem;">
                <button class="btn btn-admin" onclick="validateAdmin()">Ingresar</button>
            </div>
        </div>

        <!-- Panel de Administrador -->
        <div id="admin-screen" class="hidden">
            <div class="header">
                <h1>Panel de Administrador</h1>
                <p>Gesti√≥n de Votaciones en Tiempo Real</p>
            </div>

            <!-- Pesta√±as -->
            <div class="tabs-container">
                <button class="tab-button active" onclick="showTab('estado')">Estado</button>
                <button class="tab-button" onclick="showTab('reportes')">Estad√≠sticas</button>
            </div>

            <!-- Contenido Pesta√±a Estado -->
            <div id="tab-estado" class="tab-content active">
                <!-- Verificaci√≥n de Participantes -->
                <div class="admin-panel">
                    <h3>Verificaci√≥n de Participantes</h3>
                    <div style="display: flex; align-items: center; gap: 2rem; flex-wrap: wrap;">
                        <div style="flex: 0 0 auto;">
                            <button class="btn btn-success" onclick="checkParticipants()" style="background: linear-gradient(135deg, #17a2b8, #138496); padding: 0.8rem 1.5rem;">
                                üìã Verificar Participantes
                            </button>
                        </div>
                        
                        <div id="participants-indicator" style="flex: 1; display: flex; align-items: center; gap: 0.8rem; min-height: 45px; padding: 0.8rem; background: rgba(255, 255, 255, 0.7); border-radius: 12px; border: 1px solid var(--gray-300);">
                            <div id="status-circle" style="width: 16px; height: 16px; border-radius: 50%; background: var(--gray-500); flex-shrink: 0;"></div>
                            <span id="status-text" style="color: var(--gray-700); font-weight: 500; font-size: 0.9rem;">Estado: Sin verificar</span>
                        </div>
                    </div>
                </div>

                <!-- Estado de la Asamblea -->
                <div class="admin-panel">
                    <h3>Estado de la Asamblea</h3>
                    <div class="aforo-container" style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; align-items: center;">
                        <!-- Panel del coeficiente -->
                        <div style="text-align: center; padding: 2.5rem; background: linear-gradient(135deg, var(--success-color), #38a169); border-radius: 20px; color: white; box-shadow: var(--shadow-xl); transition: all 0.3s ease;">
                            <div id="conjunto-name-display" style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; opacity: 0.95;"></div>
                            <div id="coefficient-percentage" style="font-size: 4rem; font-weight: 800; margin-bottom: 0.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">-%</div>
                            <div style="font-size: 1.2rem; font-weight: 500; opacity: 0.9;">Aforo por Coeficiente</div>
                        </div>
                                        
                        <div class="status-container">
                            <div class="stats-grid" style="grid-template-columns: 1fr 1fr;">
                                <div class="stat-card">
                                    <div class="stat-number" id="total-participants">-</div>
                                    <div class="stat-label">Registrados</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="present-count">-</div>
                                    <div class="stat-label">Presentes</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="own-votes-count">-</div>
                                    <div class="stat-label">Aptos Propios</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="power-votes-count">-</div>
                                    <div class="stat-label">Con Poder</div>
                                </div>
                            </div>
                            
                            <div class="quorum-panel" style="background: rgba(248, 249, 250, 0.8); border: 2px solid var(--gray-300); border-radius: 16px; padding: 1.5rem; margin-top: 1rem; backdrop-filter: blur(10px);">
                                <h4 style="margin-bottom: 1rem; color: var(--dark-color); text-align: center;">Estado del Qu√≥rum</h4>
                                
                                <div class="quorum-status" style="text-align: center; margin-bottom: 1rem;">
                                    <span id="quorum-indicator" style="font-size: 2rem;">‚ùì</span>
                                    <p id="quorum-text" style="margin: 0.8rem 0; font-weight: 700; font-size: 1.4rem;">Calculando...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenido Pesta√±a Votaciones -->
            <div id="tab-votaciones" class="tab-content">
                <!-- Crear Nueva Votaci√≥n -->
                <div class="admin-panel">
                    <h3>Crear Nueva Votaci√≥n</h3>
                    <div class="question-form">
                        <select id="question-type">
                            <option value="yesno">Pregunta S√≠/No</option>
                            <option value="multiple">Elecci√≥n de Candidatos</option>
                        </select>
                        <input type="text" id="question-text" placeholder="Escriba la pregunta o cargo a elegir">
                        <textarea id="candidates-list" class="candidates-input" placeholder="Para elecciones, escriba cada candidato en una l√≠nea nueva:&#10;Juan P√©rez&#10;Mar√≠a Garc√≠a&#10;Carlos L√≥pez" style="display:none;"></textarea>
                        
                        <div id="multiple-options" style="display:none;" class="multiple-selection-panel">
                            <label style="display: block; margin-bottom: 1rem; font-weight: 500; color: var(--dark-color);">
                                M√°ximo n√∫mero de selecciones permitidas:
                            </label>
                            <input type="number" id="max-selections" min="1" value="1" style="width: 120px; padding: 0.8rem; text-align: center; font-weight: 600; margin-bottom: 1rem;">
                            <p style="font-size: 0.9rem; color: var(--gray-700); margin: 0;">
                                Si es mayor a 1, se permitir√° selecci√≥n m√∫ltiple autom√°ticamente
                            </p>
                        </div>
                        <button class="btn" onclick="createQuestion()">Crear Votaci√≥n</button>
                    </div>
                </div>

                <!-- Votaciones Activas -->
                <div class="admin-panel">
                    <h3>Votaciones Activas</h3>
                    <div id="active-questions">
                        <div class="loading">Cargando preguntas...</div>
                    </div>
                </div>
            </div>

            <!-- Contenido Pesta√±a Reportes -->
            <div id="tab-reportes" class="tab-content">
                <!-- Carga de Excel -->
                <div class="admin-panel">
                    <h3>Cargar Participantes</h3>
                    <div class="file-upload" onclick="document.getElementById('excel-file').click()">
                        <input type="file" id="excel-file" accept=".xlsx,.xls" onchange="uploadExcel()">
                        <p>üìÑ Clic para cargar archivo Excel (.xlsx)</p>
                        <small>El archivo debe contener las columnas: code, name, coefficient</small>
                    </div>
                    <div id="upload-status"></div>
                </div>
                <!-- Acciones Administrativas -->
                <div class="admin-panel">
                    <h3>Reportes y Acciones</h3>
                    <button class="btn btn-success" onclick="downloadPDF()">üìÑ Descargar PDF Asistencia</button>
                    <button class="btn btn-danger" onclick="resetDatabase()">üóëÔ∏è Limpiar Base de Datos</button>
                    <button class="btn" onclick="showDeleteCodeModal()" style="background: linear-gradient(135deg, var(--warning-color), #dd6b20);">üö´ Eliminar C√≥digo APTO</button>
                </div>
            </div>
        </div>

        <!-- Panel de Votante -->
        <div id="voter-screen" class="hidden">
            <div class="header">
                <h1>Sus Votaciones</h1>
                <p>Complete todas las votaciones disponibles</p>
            </div>

            <div class="voter-info">
                <h3 id="voter-name">Bienvenido/a</h3>
                <p>C√≥digo: <strong id="voter-code">-</strong></p>
                <p>Estado: <span id="voter-status">Conectado</span></p>
                <div class="attendance-info">‚úÖ Asistencia registrada autom√°ticamente</div>
            </div>

            <div id="voting-questions">
                <div class="loading">Cargando votaciones...</div>
            </div>
        </div>
    </div>

    <div class="status-panel hidden" id="status-panel">
        <div id="status-content"></div>
    </div>

    <script>
        // Configuraci√≥n de la API
        const API_BASE = 'https://web-production-b3d70.up.railway.app/api';
        
        // Variables globales - LIMPIADAS Y ORGANIZADAS
        let adminToken = null;
        let voterToken = null;
        let currentUser = null;
        let isAdmin = false;
        let updateInterval = null;
        let syncChannel = null;
        let lastUpdateTimestamp = 0;

        // Constantes
        const CODIGO_PRUEBA = '999-999';

        // ======= UTILIDADES Y CONFIGURACI√ìN =======
        
        // Inicializar comunicaci√≥n entre pesta√±as
        function initTabSync() {
            if ('BroadcastChannel' in window) {
                syncChannel = new BroadcastChannel('admin-sync');
                syncChannel.onmessage = handleSyncMessage;
            }
        }

        function handleSyncMessage(event) {
            const { type, data, timestamp } = event.data;
            
            if (timestamp <= lastUpdateTimestamp) return;
            lastUpdateTimestamp = timestamp;
            
            switch (type) {
                case 'aforo-update':
                    if (isAdmin) updateAforoDisplay(data);
                    break;
                case 'questions-update':
                    if (isAdmin) renderActiveQuestions(data);
                    break;
                case 'force-refresh':
                    if (isAdmin) loadAdminData();
                    break;
                case 'force-refresh-voters':
                    if (!isAdmin && voterToken) loadVotingQuestions();
                    break;
            }
        }

        function broadcastSync(type, data) {
            if (syncChannel) {
                const timestamp = Date.now();
                lastUpdateTimestamp = timestamp;
                syncChannel.postMessage({ type, data, timestamp });
            }
        }

        // Gesti√≥n de tokens
        function saveToken(type, token) {
            localStorage.setItem(`${type}_token`, token);
        }

        function getToken(type) {
            return localStorage.getItem(`${type}_token`);
        }

        function clearTokens() {
            localStorage.removeItem('admin_token');
            localStorage.removeItem('voter_token');
        }

        // ======= COMUNICACI√ìN CON API =======
        
        async function apiCall(endpoint, options = {}) {
            const token = isAdmin ? adminToken : voterToken;
            
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            };

            if (token) {
                config.headers.Authorization = `Bearer ${token}`;
            }

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, config);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }

                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return await response.json();
                } else {
                    return response;
                }
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // ======= NAVEGACI√ìN Y UI =======
        
        function showScreen(screenId) {
            document.querySelectorAll('.container > div').forEach(div => div.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            document.querySelector('.logout-btn').classList.toggle('hidden', screenId === 'welcome-screen');
        }

        function logout() {
            // Limpiar comunicaci√≥n entre pesta√±as
            if (syncChannel) {
                syncChannel.close();
                syncChannel = null;
            }

            // Limpiar tokens y variables
            clearTokens();
            adminToken = null;
            voterToken = null;
            currentUser = null;
            isAdmin = false;
            
            // Limpiar intervalos
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }

            // Limpiar todos los intervalos y timeouts
            const highestId = setTimeout(() => {}, 0);
            for (let i = 0; i < highestId; i++) {
                clearInterval(i);
                clearTimeout(i);
            }

            // Limpiar formularios
            document.getElementById('access-code').value = '';
            document.getElementById('admin-username').value = '';
            document.getElementById('admin-password').value = '';
            document.getElementById('admin-login').classList.add('hidden');
            
            showScreen('welcome-screen');
            hideStatus();
        }

        // ======= FUNCIONES DE ACCESO =======
        
        function showAdminLogin() {
            const adminLogin = document.getElementById('admin-login');
            adminLogin.classList.toggle('hidden');
        }

        async function accessVoting() {
            const code = document.getElementById('access-code').value.trim().toUpperCase();
            
            if (!code || !/^\d+-\d+$/.test(code)) {
                showStatus('Formato de c√≥digo inv√°lido. Use formato Torre-Apto (ej: 1-201)', 'error');
                return;
            }

            if (code === CODIGO_PRUEBA) {
                currentUser = {
                    code: CODIGO_PRUEBA,
                    name: 'Usuario de Prueba',
                    id: 'test'
                };
                isAdmin = false;
                showTestVoterScreen();
                return;
            }

            try {
                showStatus('Verificando acceso a votaciones...', 'info');
                
                const response = await apiCall('/auth/login/voter', {
                    method: 'POST',
                    body: JSON.stringify({ code: code })
                });

                voterToken = response.access_token;
                saveToken('voter', voterToken);
                currentUser = {
                    code: code,
                    name: response.name || 'Usuario',
                    id: response.user_id || null
                };
                isAdmin = false;
                
                showVoterScreen();
                showStatus('Acceso a votaciones autorizado', 'success');
            } catch (error) {
                if (error.message.includes('no registrado') || error.message.includes('not found')) {
                    showStatus('Debe registrar su asistencia primero usando "Solo Asistencia"', 'error');
                } else {
                    showStatus(`Error: ${error.message}`, 'error');
                }
            }
        }

        function showTestVoterScreen() {
            currentUser = {
                code: CODIGO_PRUEBA,
                name: 'Usuario de Prueba',
                id: 'test'
            };
            isAdmin = false;
            showVoterScreen();
            loadTestVotingQuestions();
            startVotingPolling();
        }

        function getSimulatedTestQuestions() {
            return [
                {
                    id: 9991,
                    text: "[PRUEBA] ¬øAprueba la propuesta de mejoras?",
                    type: "yesno",
                    closed: false,
                    options: [{text: 'S√≠'}, {text: 'No'}]
                },
                {
                    id: 9992, 
                    text: "[PRUEBA] Elija el representante de la junta",
                    type: "multiple",
                    closed: false,
                    allow_multiple: false,
                    max_selections: 1,
                    options: [
                        {text: "Juan P√©rez"}, 
                        {text: "Mar√≠a Garc√≠a"}, 
                        {text: "Carlos L√≥pez"}
                    ]
                },
                {
                    id: 9993,
                    text: "[PRUEBA] Seleccione mejoras prioritarias (m√°ximo 2)",
                    type: "multiple", 
                    closed: false,
                    allow_multiple: true,
                    max_selections: 2,
                    options: [
                        {text: "Piscina"}, 
                        {text: "Gimnasio"}, 
                        {text: "Jardines"}, 
                        {text: "Parqueaderos"}
                    ]
                }
            ];
        }

        async function loadTestVotingQuestions() {
            const testQuestions = getSimulatedTestQuestions();
            renderVotingQuestions(testQuestions);
            showStatus('Votaciones de prueba cargadas (solo demostraci√≥n)', 'info');
        }

        async function registerAttendance() {
            const code = document.getElementById('access-code').value.trim().toUpperCase();
            
            if (!code || !/^\d+-\d+$/.test(code)) {
                showStatus('Formato de c√≥digo inv√°lido. Use formato Torre-Apto (ej: 1-201)', 'error');
                return;
            }

            if (code === CODIGO_PRUEBA) {
                showTestUserModal();
                return;
            }

            try {
                showStatus('Registrando asistencia...', 'info');
                
                const isPower = await showPowerQuestion();
                
                const response = await apiCall('/auth/register-attendance', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        code: code,
                        is_power: isPower
                    })
                });

                showAttendanceModal(response);
                showStatus('Asistencia registrada correctamente', 'success');
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        function showTestUserModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.7); display: flex; align-items: center; 
                justify-content: center; z-index: 2000;
            `;
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 16px; max-width: 400px; text-align: center; backdrop-filter: blur(20px);">
                    <h3 style="color: var(--warning-color); margin-bottom: 1.5rem;">üß™ Usuario de Prueba</h3>
                    <p><strong>C√≥digo:</strong> ${CODIGO_PRUEBA}</p>
                    <p><strong>Tipo:</strong> Demostraci√≥n</p>
                    <p style="color: var(--gray-700); font-size: 0.9rem;">Este usuario no afecta estad√≠sticas reales</p>
                    <button class="btn" onclick="document.body.removeChild(this.closest('div').parentNode); accessTestVoting()">
                        Ir a Votaciones de Prueba
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function accessTestVoting() {
            showTestVoterScreen();
        }

        function showAttendanceModal(userData) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.7); display: flex; align-items: center; 
                justify-content: center; z-index: 2000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 16px; max-width: 400px; text-align: center; backdrop-filter: blur(20px);">
                    <h3 style="color: var(--success-color); margin-bottom: 1.5rem;">‚úÖ Asistencia Registrada</h3>
                    <p><strong>C√≥digo:</strong> ${userData.code}</p>
                    <p><strong>Nombre:</strong> ${userData.name}</p>
                    <p><strong>Tipo:</strong> ${userData.is_power ? 'Con Poder' : 'Propietario'}</p>
                    <button class="btn" onclick="document.body.removeChild(this.closest('div').parentNode)" style="margin-top: 1.5rem;">
                        Cerrar
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function showPowerQuestion() {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.5); display: flex; align-items: center; 
                    justify-content: center; z-index: 2000;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; padding: 2rem; border-radius: 16px; max-width: 400px; text-align: center; backdrop-filter: blur(20px);">
                        <h3 style="margin-bottom: 1rem; color: var(--dark-color);">Informaci√≥n del Apto</h3>
                        <p style="margin-bottom: 1.5rem; color: var(--gray-700);">¬øEste apartamento es suyo o tiene poder para votar por √©l?</p>
                        <button class="btn btn-large" onclick="selectPowerOption(false)" style="margin: 0.5rem;">
                            Soy propietario
                        </button>
                        <button class="btn btn-large" onclick="selectPowerOption(true)" style="margin: 0.5rem; background: linear-gradient(135deg, var(--warning-color), #dd6b20);">
                            Tengo poder
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                window.selectPowerOption = (isPower) => {
                    console.log("DEBUG FRONTEND: isPower =", isPower, "tipo:", typeof isPower);
                    document.body.removeChild(modal);
                    delete window.selectPowerOption;
                    resolve(isPower);
                };
            });
        }

        async function validateAdmin() {
            const username = document.getElementById('admin-username').value.trim();
            const password = document.getElementById('admin-password').value.trim();
            
            if (!username || !password) {
                showStatus('Complete usuario y contrase√±a', 'error');
                return;
            }

            try {
                showStatus('Verificando credenciales...', 'info');
                
                const formData = new URLSearchParams();
                formData.append('username', username);
                formData.append('password', password);

                const response = await apiCall('/auth/login/admin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formData
                });

                adminToken = response.access_token;
                saveToken('admin', adminToken);
                isAdmin = true;
                
                showAdminScreen();
                showStatus('Acceso de administrador autorizado', 'success');
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // ======= FUNCIONES DEL ADMINISTRADOR =======
        
        async function showAdminScreen() {
            showScreen('admin-screen');
            await loadAdminData();
            await checkConjuntoName();
            await autoCheckOnLoad();
            startAutoRefresh();
            
            // Configurar cambio de tipo de pregunta - VERSI√ìN √öNICA Y CORREGIDA
            const questionTypeSelect = document.getElementById('question-type');
            const candidatesList = document.getElementById('candidates-list');
            const multipleOptions = document.getElementById('multiple-options');
            
            // Remover listeners previos para evitar duplicados
            questionTypeSelect.onchange = null;
            
            questionTypeSelect.addEventListener('change', function() {
                if (this.value === 'multiple') {
                    candidatesList.style.display = 'block';
                    multipleOptions.style.display = 'block';
                } else {
                    candidatesList.style.display = 'none';
                    multipleOptions.style.display = 'none';
                }
            });
            
            initTabSync();
        }

        async function loadAdminData() {
            await Promise.all([
                loadAforoData(),
                loadActiveQuestions()
            ]);
        }

        async function uploadExcel() {
            const fileInput = document.getElementById('excel-file');
            const file = fileInput.files[0];
            
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                showStatus('Subiendo archivo...', 'info');
                
                const response = await fetch(`${API_BASE}/participants/upload-xlsx`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Error al subir archivo');
                }

                const result = await response.json();
                document.getElementById('upload-status').innerHTML = 
                    `<div style="color: var(--success-color); margin-top: 1rem;">‚úì ${result.inserted} participantes cargados correctamente</div>`;
                
                showStatus(`Archivo cargado: ${result.inserted} participantes`, 'success');
                
                if (result.inserted > 0) {
                    document.getElementById('status-circle').style.background = 'var(--success-color)';
                    document.getElementById('status-text').textContent = `${result.inserted} participantes registrados`;
                    document.getElementById('status-text').style.color = 'var(--success-color)';
                }
                
                await loadAforoData();
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                document.getElementById('upload-status').innerHTML = 
                    `<div style="color: var(--danger-color); margin-top: 1rem;">‚úó ${error.message}</div>`;
                
                document.getElementById('status-circle').style.background = 'var(--danger-color)';
                document.getElementById('status-text').textContent = 'Error cargando archivo';
                document.getElementById('status-text').style.color = 'var(--danger-color)';
            }
        }

        async function checkParticipants() {
            try {
                showStatus('Verificando participantes...', 'info');
                
                const response = await apiCall('/participants/');
                
                if (response.length === 0) {
                    document.getElementById('status-circle').style.background = 'var(--gray-500)';
                    document.getElementById('status-text').textContent = 'Sin participantes registrados';
                    document.getElementById('status-text').style.color = 'var(--gray-500)';
                    
                    showParticipantsModal('No hay participantes registrados', []);
                    showStatus('No hay participantes en la base de datos', 'error');
                } else {
                    document.getElementById('status-circle').style.background = 'var(--success-color)';
                    document.getElementById('status-text').textContent = `${response.length} participantes registrados`;
                    document.getElementById('status-text').style.color = 'var(--success-color)';
                    
                    showParticipantsModal(`${response.length} participantes encontrados`, response);
                    showStatus(`‚úÖ ${response.length} participantes verificados`, 'success');
                }
            } catch (error) {
                document.getElementById('status-circle').style.background = 'var(--danger-color)';
                document.getElementById('status-text').textContent = 'Error al verificar';
                document.getElementById('status-text').style.color = 'var(--danger-color)';
                
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // FUNCI√ìN √öNICA Y CORREGIDA showParticipantsModal
        function showParticipantsModal(title, participants) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.7); display: flex; align-items: center; 
                justify-content: center; z-index: 2000;
            `;
            
            const participantsPerPage = 25;
            let currentPage = 1;
            let filteredParticipants = [...participants];
            
            function renderPage() {
                const startIndex = (currentPage - 1) * participantsPerPage;
                const endIndex = startIndex + participantsPerPage;
                const pageParticipants = filteredParticipants.slice(startIndex, endIndex);
                const totalPages = Math.ceil(filteredParticipants.length / participantsPerPage);
                
                const paginationHTML = totalPages > 1 ? `
                    <div style="padding: 1rem; background: rgba(255, 255, 255, 0.9); border: 1px solid var(--gray-300); border-radius: 12px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                        <button onclick="changePage(${currentPage - 1})" 
                                ${currentPage === 1 ? 'disabled' : ''} 
                                style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); background: ${currentPage === 1 ? 'var(--gray-200)' : 'white'}; border-radius: 8px; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'};">
                            ‚Üê Anterior
                        </button>
                        <span style="color: var(--gray-700); font-size: 0.9rem;">
                            P√°gina ${currentPage} de ${totalPages} (${filteredParticipants.length} resultados)
                        </span>
                        <button onclick="changePage(${currentPage + 1})" 
                                ${currentPage === totalPages ? 'disabled' : ''} 
                                style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); background: ${currentPage === totalPages ? 'var(--gray-200)' : 'white'}; border-radius: 8px; cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'};">
                            Siguiente ‚Üí
                        </button>
                    </div>
                ` : '';
                
                document.getElementById('pagination-top').innerHTML = paginationHTML;
                
                const participantsList = filteredParticipants.length === 0 ? 
                    '<p style="text-align: center; color: var(--gray-700); font-style: italic; padding: 2rem;">No se encontraron participantes</p>' :
                    `<div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--gray-300); border-radius: 12px; background: rgba(248, 249, 250, 0.8);">
                        ${pageParticipants.map(p => `
                            <div style="padding: 0.8rem 1rem; border-bottom: 1px solid var(--gray-300); display: grid; grid-template-columns: 100px 1fr 80px; gap: 1rem; align-items: center;">
                                <span style="font-weight: 600; color: var(--dark-color);">${p.code}</span>
                                <span style="color: var(--gray-700); overflow: hidden; text-overflow: ellipsis;">${p.name || 'Sin nombre'}</span>
                                <span style="color: var(--primary-color); font-weight: 500; text-align: right;">${p.coefficient || 0}%</span>
                            </div>
                        `).join('')}
                    </div>`;
                
                document.getElementById('participants-content').innerHTML = participantsList;
            }
            
            function filterParticipants(searchTerm) {
                if (!searchTerm.trim()) {
                    filteredParticipants = [...participants];
                } else {
                    filteredParticipants = participants.filter(p => 
                        p.code.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        (p.name || '').toLowerCase().includes(searchTerm.toLowerCase())
                    );
                }
                currentPage = 1;
                renderPage();
            }
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 20px; max-width: 700px; width: 90%; max-height: 80vh; overflow: hidden; position: relative; backdrop-filter: blur(20px);">
                    <h3 style="margin-bottom: 1.5rem; color: var(--dark-color); text-align: center;">${title}</h3>
                    
                    <!-- Buscador -->
                    <div style="margin-bottom: 1.5rem;">
                        <input type="text" id="participant-search" placeholder="Buscar por c√≥digo o nombre..." 
                            style="width: 100%; padding: 0.8rem; border: 2px solid var(--gray-300); border-radius: 12px; font-size: 1rem;"
                            oninput="filterParticipants(this.value)">
                    </div>
                    
                    <!-- Paginaci√≥n arriba -->
                    <div id="pagination-top"></div>

                    <!-- Contenido de participantes -->
                    <div id="participants-content"></div>
                    
                    <!-- Bot√≥n X en esquina superior derecha -->
                    <button onclick="document.body.removeChild(this.closest('div').parentNode)" 
                            style="position: absolute; top: 15px; right: 15px; background: var(--danger-color); color: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; font-size: 18px; font-weight: bold; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-md);"
                            title="Cerrar">
                        √ó
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Funciones globales para el modal
            window.changePage = (newPage) => {
                const totalPages = Math.ceil(filteredParticipants.length / participantsPerPage);
                if (newPage >= 1 && newPage <= totalPages) {
                    currentPage = newPage;
                    renderPage();
                }
            };
            
            window.filterParticipants = filterParticipants;
            
            // Renderizar primera p√°gina
            renderPage();
            
            // Focus en el buscador
            setTimeout(() => document.getElementById('participant-search').focus(), 100);
            
            // Limpiar funciones globales al cerrar
            const closeBtn = modal.querySelector('button[onclick*="removeChild"]');
            const originalClose = closeBtn.onclick;
            closeBtn.onclick = () => {
                delete window.changePage;
                delete window.filterParticipants;
                originalClose();
            };
        }

        async function autoCheckOnLoad() {
            try {
                const response = await apiCall('/participants/');
                const count = response.length;
                
                if (count > 0) {
                    document.getElementById('status-circle').style.background = 'var(--success-color)';
                    document.getElementById('status-text').textContent = `${count} participantes registrados`;
                    document.getElementById('status-text').style.color = 'var(--success-color)';
                }
            } catch (error) {
                // Silencioso, no mostrar error en auto-check
            }
        }

        async function loadAforoData() {
            try {
                const data = await apiCall('/voting/aforo');
                
                // Actualizar contadores b√°sicos
                document.getElementById('total-participants').textContent = data.total_participants || 0;
                document.getElementById('present-count').textContent = data.present_count || 0;
                document.getElementById('own-votes-count').textContent = data.own_votes || 0;
                document.getElementById('power-votes-count').textContent = data.power_votes || 0;
                
                // Actualizar porcentaje del coeficiente
                const coefficientPercentage = data.coefficient_rate_percent || 0;
                document.getElementById('coefficient-percentage').textContent = `${(coefficientPercentage).toFixed(2)}%`;

                // Cambiar color del panel seg√∫n qu√≥rum
                const quorumRequired = 51;
                const quorumMet = (coefficientPercentage) >= quorumRequired;
                const panel = document.querySelector('.aforo-container > div:first-child');

                if (quorumMet) {
                    panel.style.background = 'linear-gradient(135deg, var(--success-color), #38a169)';
                } else {
                    panel.style.background = 'linear-gradient(135deg, var(--danger-color), #e53e3e)';
                }
                
                const indicator = document.getElementById('quorum-indicator');
                const text = document.getElementById('quorum-text');
                
                if (quorumMet) {
                    indicator.textContent = '‚úÖ';
                    indicator.style.color = 'var(--success-color)';
                    text.textContent = 'QU√ìRUM ALCANZADO';
                    text.style.color = 'var(--success-color)';
                } else {
                    indicator.textContent = '‚ùå';
                    indicator.style.color = 'var(--danger-color)';
                    text.textContent = 'SIN QU√ìRUM';
                    text.style.color = 'var(--danger-color)';
                }

                broadcastSync('aforo-update', {
                    total_participants: data.total_participants || 0,
                    present_count: data.present_count || 0,
                    own_votes: data.own_votes || 0,
                    power_votes: data.power_votes || 0,
                    coefficient_rate_percent: data.coefficient_rate_percent || 0
                });

            } catch (error) {
                console.error('Error loading aforo:', error);
                // Mostrar valores de error
                document.getElementById('total-participants').textContent = 'Error';
                document.getElementById('present-count').textContent = 'Error';
                document.getElementById('own-votes-count').textContent = 'Error';
                document.getElementById('power-votes-count').textContent = 'Error';
                document.getElementById('coefficient-percentage').textContent = 'Error';
            }
        }

        function updateAforoDisplay(data) {
            document.getElementById('total-participants').textContent = data.total_participants;
            document.getElementById('present-count').textContent = data.present_count;
            document.getElementById('own-votes-count').textContent = data.own_votes;
            document.getElementById('power-votes-count').textContent = data.power_votes;
            
            const coefficientPercentage = data.coefficient_rate_percent;
            document.getElementById('coefficient-percentage').textContent = `${coefficientPercentage.toFixed(2)}%`;
            
            // Actualizar color del panel
            const quorumRequired = 51;
            const quorumMet = coefficientPercentage >= quorumRequired;
            const panel = document.querySelector('.aforo-container > div:first-child');
            
            if (quorumMet) {
                panel.style.background = 'linear-gradient(135deg, var(--success-color), #38a169)';
            } else {
                panel.style.background = 'linear-gradient(135deg, var(--danger-color), #e53e3e)';
            }
            
            const indicator = document.getElementById('quorum-indicator');
            const text = document.getElementById('quorum-text');
            
            if (quorumMet) {
                indicator.textContent = '‚úÖ';
                indicator.style.color = 'var(--success-color)';
                text.textContent = 'QU√ìRUM ALCANZADO';
                text.style.color = 'var(--success-color)';
            } else {
                indicator.textContent = '‚ùå';
                indicator.style.color = 'var(--danger-color)';
                text.textContent = 'SIN QU√ìRUM';
                text.style.color = 'var(--danger-color)';
            }
        }

        async function createQuestion() {
            const type = document.getElementById('question-type').value;
            const text = document.getElementById('question-text').value.trim();
            
            if (!text) {
                showStatus('Ingrese el texto de la pregunta', 'error');
                return;
            }

            const questionData = {
                text: text,
                type: type
            };

            if (type === 'multiple') {
                const candidates = document.getElementById('candidates-list').value
                    .split('\n')
                    .map(c => c.trim())
                    .filter(c => c.length > 0);
                
                if (candidates.length < 2) {
                    showStatus('Ingrese al menos 2 candidatos para elecci√≥n m√∫ltiple', 'error');
                    return;
                }
                questionData.options = candidates;
                
                // Opciones de selecci√≥n m√∫ltiple
                const maxSelections = parseInt(document.getElementById('max-selections').value) || 1;
                const allowMultiple = maxSelections > 1;

                questionData.allow_multiple = allowMultiple;
                questionData.max_selections = maxSelections;
                
                if (allowMultiple && maxSelections > candidates.length) {
                    showStatus('El m√°ximo de selecciones no puede ser mayor al n√∫mero de candidatos', 'error');
                    return;
                }
            }

            try {
                showStatus('Creando votaci√≥n...', 'info');
                
                await apiCall('/voting/questions', {
                    method: 'POST',
                    body: JSON.stringify(questionData)
                });

                // Limpiar formulario
                document.getElementById('question-text').value = '';
                document.getElementById('candidates-list').value = '';
                document.getElementById('max-selections').value = '1';

                showStatus('Votaci√≥n creada y activada', 'success');

                const questions = await apiCall('/voting/questions/active');
                renderActiveQuestions(questions);
                showStatus('Votaci√≥n creada y activada', 'success');
                broadcastSync('force-refresh-voters', {});
                broadcastSync('questions-update', questions);
                broadcastSync('force-refresh', {});
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function deleteQuestion(questionId) {
            if (!confirm('¬øEliminar esta encuesta? Se borrar√°n tambi√©n todos los votos.')) return;
            
            try {
                await apiCall(`/voting/questions/${questionId}`, { method: 'DELETE' });
                const questions = await apiCall('/voting/questions/active');
                renderActiveQuestions(questions);
                showStatus('Encuesta eliminada', 'success');
                broadcastSync('force-refresh-voters', {});
                broadcastSync('force-refresh', {});
                broadcastSync('questions-update', questions);
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function loadActiveQuestions() {
            try {
                const questions = await apiCall('/voting/questions/active');
                renderActiveQuestions(questions);
                broadcastSync('questions-update', questions);
            } catch (error) {
                console.error('Error loading questions:', error);
                document.getElementById('active-questions').innerHTML = 
                    '<p style="color: var(--danger-color); padding: 1rem;">Error cargando preguntas activas</p>';
            }
        }

        function renderActiveQuestions(questions) {
            const container = document.getElementById('active-questions');
            
            if (questions.length === 0) {
                container.innerHTML = '<p style="color: var(--gray-700);">No hay votaciones creadas</p>';
                return;
            }

            container.innerHTML = questions.map(q => `
                <div class="voting-section" style="position: relative;">
                    <!-- Bot√≥n de eliminar en esquina superior derecha -->
                    <button onclick="deleteQuestion(${q.id})" 
                            style="position: absolute; top: 10px; right: 10px; background: var(--danger-color); color: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-md); transition: all 0.2s ease;"
                            onmouseover="this.style.background='#e53e3e'; this.style.transform='scale(1.1)'"
                            onmouseout="this.style.background='var(--danger-color)'; this.style.transform='scale(1)'"
                            title="Eliminar votaci√≥n">
                        üóëÔ∏è
                    </button>
                    
                    <h4 style="margin-bottom: 0.8rem; color: var(--dark-color); padding-right: 50px;">${q.text}</h4>
                    <p><strong>Tipo:</strong> ${q.type === 'yesno' ? 'S√≠/No' : 'M√∫ltiple opci√≥n'}</p>
                    <p><strong>Opciones:</strong> ${q.options ? q.options.map(opt => opt.text).join(', ') : 'S√≠, No'}</p>
                    <p><strong>Estado:</strong> ${q.closed ? 'üîí Cerrada' : 'üü¢ Abierta'}</p>
                    <button class="btn ${q.closed ? 'btn-success' : 'btn-danger'}" onclick="toggleQuestion(${q.id})">
                        ${q.closed ? 'Abrir' : 'Cerrar'}
                    </button>
                    <button class="btn btn-success" onclick="viewResults(${q.id})">Ver Resultados Detallados</button>
                    ${q.closed ? `<button class="btn" onclick="editQuestion(${q.id})" style="background: linear-gradient(135deg, var(--warning-color), #dd6b20); font-size: 0.85rem; padding: 0.6rem 1rem;">‚úèÔ∏è Editar</button>` : ''}
                </div>
            `).join('');
        }

        async function editQuestion(questionId) {
            try {
                const questions = await apiCall('/voting/questions/active');
                const question = questions.find(q => q.id === questionId);
                if (!question) {
                    showStatus('Votaci√≥n no encontrada', 'error');
                    return;
                }
                showEditModal(question);

            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        function showEditModal(question) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.7); display: flex; align-items: center; 
                justify-content: center; z-index: 2000;
            `;
            
            const isMultiple = question.type === 'multiple';
            const options = question.options || [];
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 20px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; backdrop-filter: blur(20px);">
                    <h3 style="margin-bottom: 1.5rem; color: var(--dark-color);">‚úèÔ∏è Editar Votaci√≥n</h3>
                    
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Pregunta:</label>
                    <input type="text" id="edit-question-text" value="${question.text}" 
                        style="width: 100%; padding: 0.8rem; border: 2px solid var(--gray-300); border-radius: 12px; margin-bottom: 1rem;">
                    
                    ${isMultiple ? `
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Opciones (una por l√≠nea):</label>
                        <textarea id="edit-candidates-list" style="width: 100%; min-height: 150px; padding: 0.8rem; border: 2px solid var(--gray-300); border-radius: 12px; margin-bottom: 1rem; resize: vertical;">${options.map(opt => opt.text).join('\n')}</textarea>
                        
                        ${question.allow_multiple ? `
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">M√°ximo selecciones:</label>
                            <input type="number" id="edit-max-selections" value="${question.max_selections}" min="1" 
                                style="width: 120px; padding: 0.8rem; border: 2px solid var(--gray-300); border-radius: 12px; margin-bottom: 1rem;">
                        ` : ''}
                    ` : ''}
                    
                    <div style="text-align: center; margin-top: 1.5rem;">
                        <button class="btn" onclick="saveEditedQuestion(${question.id})" style="margin-right: 1rem;">Guardar Cambios</button>
                        <button class="btn" onclick="closeEditModal()" style="background: linear-gradient(135deg, var(--gray-500), var(--gray-700));">Cancelar</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            setTimeout(() => document.getElementById('edit-question-text').focus(), 100);
            
            window.saveEditedQuestion = async (questionId) => {
                const newText = document.getElementById('edit-question-text').value.trim();
                
                if (!newText) {
                    showStatus('La pregunta no puede estar vac√≠a', 'error');
                    return;
                }
                
                const updateData = { text: newText };
                
                const candidatesList = document.getElementById('edit-candidates-list');
                if (candidatesList) {
                    const newOptions = candidatesList.value.split('\n')
                        .map(c => c.trim())
                        .filter(c => c.length > 0);
                        
                    if (newOptions.length < 2) {
                        showStatus('Debe tener al menos 2 opciones', 'error');
                        return;
                    }
                    
                    updateData.options = newOptions;
                    
                    const maxSelectionsInput = document.getElementById('edit-max-selections');
                    if (maxSelectionsInput) {
                        const maxSelections = parseInt(maxSelectionsInput.value);
                        if (maxSelections > newOptions.length) {
                            showStatus('El m√°ximo de selecciones no puede ser mayor al n√∫mero de opciones', 'error');
                            return;
                        }
                        updateData.max_selections = maxSelections;
                    }
                }
                
                try {
                    showStatus('Guardando cambios...', 'info');
                    
                    await apiCall(`/voting/questions/${questionId}`, {
                        method: 'PUT',
                        body: JSON.stringify(updateData)
                    });
                    
                    closeEditModal();
                    const questions = await apiCall('/voting/questions/active');
                    renderActiveQuestions(questions);
                    showStatus('Votaci√≥n actualizada correctamente', 'success');
                    broadcastSync('force-refresh-voters', {});
                    broadcastSync('questions-update', questions);
                } catch (error) {
                    showStatus(`Error: ${error.message}`, 'error');
                }
            };

            window.closeEditModal = () => {
                document.body.removeChild(modal);
                delete window.closeEditModal;
                delete window.saveEditedQuestion;
            };
        }

        async function toggleQuestion(questionId) {
            try {
                await apiCall(`/voting/questions/${questionId}/toggle`, { method: 'PUT' });
                const questions = await apiCall('/voting/questions/active');
                renderActiveQuestions(questions);
                showStatus('Estado de votaci√≥n actualizado', 'success');
                broadcastSync('force-refresh-voters', {});
                broadcastSync('force-refresh', {});
                broadcastSync('questions-update', questions);
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function checkUserVotes() {
            try {
                const userVotes = await apiCall('/voting/my-votes');
                return new Set(userVotes.map(vote => vote.question_id));
            } catch (error) {
                console.error('Error al comprobar los votos de los usuarios:', error);
                return new Set();
            }
        }

        async function viewResults(questionId) {
            let updateInterval = null;
            
            try {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.7); display: flex; align-items: center; 
                    justify-content: center; z-index: 2000;
                `;
                
                const updateModalContent = async () => {
                    try {
                        const results = await apiCall(`/voting/results/${questionId}`);
                        const aforo = await apiCall('/voting/aforo');
                        
                        const content = document.getElementById('modal-content');
                        if (content) {
                            content.innerHTML = `
                                <div style="background: rgba(248, 249, 250, 0.8); padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem;">
                                    <p><strong>Pregunta:</strong> ${results.question_text}</p>
                                    <p><strong>Total presentes en asamblea:</strong> ${aforo.present_count}</p>
                                    <p><strong>Participaron en esta votaci√≥n:</strong> ${results.total_participants}</p>
                                    <p><strong>Participaci√≥n:</strong> ${results.total_participant_coefficient.toFixed(2)}%</p>
                                </div>
                                
                                <div class="results-container">
                                    ${results.results ? results.results.map(result => `
                                        <div class="result-item">
                                            <span><strong>${result.answer}:</strong></span>
                                            <div class="progress-bar">
                                                <div class="progress-fill" style="width: ${result.percentage}%; background: linear-gradient(90deg, var(--primary-color), var(--success-color));"></div>
                                            </div>
                                            <span>${result.votes} votos (${result.percentage.toFixed(2)}%)</span>
                                        </div>
                                    `).join('') : '<p>Sin votos registrados</p>'}
                                </div>
                            `;
                        }
                    } catch (error) {
                        console.error('Error updating modal:', error);
                    }
                };
                
                modal.innerHTML = `
                    <div style="background: white; padding: 2rem; border-radius: 20px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; backdrop-filter: blur(20px);">
                        <h3 style="margin-bottom: 1.5rem; color: var(--dark-color);">Resultados Detallados (Tiempo Real)</h3>
                        
                        <div id="modal-content">
                            <div class="loading">Cargando...</div>
                        </div>
                        
                        <button class="btn" onclick="closeResultsModal()" style="margin-top: 1.5rem; width: 100%;">
                            Cerrar
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                window.closeResultsModal = () => {
                    if (updateInterval) {
                        clearInterval(updateInterval);
                        updateInterval = null;
                    }
                    document.body.removeChild(modal);
                    delete window.closeResultsModal;
                };
                
                await updateModalContent();
                updateInterval = setInterval(updateModalContent, 2000);
                
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function downloadPDF() {
            await confirmDownloadPDF();
        }

        async function checkConjuntoName() {
            try {
                const response = await apiCall('/participants/conjunto/nombre');
                const nombreActual = response.nombre || '';
                
                if (!nombreActual) {
                    await showConjuntoModal();
                } else {
                    updateConjuntoDisplay(nombreActual);
                }
            } catch (error) {
                console.error('Error obteniendo nombre conjunto:', error);
                await showConjuntoModal();
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
        }

        function showConjuntoModal() {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.7); display: flex; align-items: center; 
                    justify-content: center; z-index: 2000;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; padding: 2rem; border-radius: 20px; max-width: 400px; width: 90%; backdrop-filter: blur(20px);">
                        <h3 style="margin-bottom: 1.5rem; color: var(--dark-color); text-align: center;">Configurar Conjunto</h3>
                        
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--dark-color);">
                            Nombre del Conjunto Residencial:
                        </label>
                        <input type="text" id="conjunto-name-input" placeholder="Ej: Conjunto Torres del Parque" 
                            style="width: 100%; padding: 0.8rem; border: 2px solid var(--gray-300); border-radius: 12px; font-size: 1rem; margin-bottom: 1.5rem;">
                        
                        <div style="text-align: center;">
                            <button class="btn btn-success" onclick="saveConjuntoName()" style="width: 100%;">
                                Guardar
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                setTimeout(() => document.getElementById('conjunto-name-input').focus(), 100);
                
                window.saveConjuntoName = async () => {
                    const nombre = document.getElementById('conjunto-name-input').value.trim();
                    if (!nombre) {
                        showStatus('Por favor ingrese el nombre del conjunto', 'error');
                        return;
                    }
                    
                    try {
                        await apiCall('/participants/conjunto/nombre', {
                            method: 'POST',
                            body: JSON.stringify({ nombre: nombre })
                        });
                        
                        updateConjuntoDisplay(nombre);
                        document.body.removeChild(modal);
                        delete window.saveConjuntoName;
                        showStatus('Nombre del conjunto guardado', 'success');
                        resolve(true);
                    } catch (error) {
                        showStatus(`Error: ${error.message}`, 'error');
                    }
                };
            });
        }

        function updateConjuntoDisplay(nombre) {
            const header = document.querySelector('#admin-screen .header h1');
            if (header) {
                header.innerHTML = `Panel de Administrador`;
            }
            
            const conjuntoDisplay = document.getElementById('conjunto-name-display');
            if (conjuntoDisplay) {
                conjuntoDisplay.textContent = nombre;
            }
        }

        async function confirmDownloadPDF() {
            try {
                showStatus('Generando archivos...', 'info');
                
                const pdfResponse = await apiCall('/participants/asistencia/pdf', {
                    method: 'POST'
                });

                if (!pdfResponse.ok) {
                    throw new Error('Error generando PDF');
                }

                const excelResponse = await apiCall('/participants/asistencia/xlsx', {
                    method: 'POST'
                });

                if (!excelResponse.ok) {
                    throw new Error('Error generando Excel');
                }

                const conjuntoData = await apiCall('/participants/conjunto/nombre');
                const nombreArchivo = conjuntoData.nombre.replace(/\s+/g, '_') || 'conjunto';

                const pdfBlob = await pdfResponse.blob();
                const pdfUrl = window.URL.createObjectURL(pdfBlob);
                const pdfLink = document.createElement('a');
                pdfLink.href = pdfUrl;
                pdfLink.download = `reporte_completo_${nombreArchivo}.pdf`;
                pdfLink.click();
                window.URL.revokeObjectURL(pdfUrl);

                const excelBlob = await excelResponse.blob();
                const excelUrl = window.URL.createObjectURL(excelBlob);
                const excelLink = document.createElement('a');
                excelLink.href = excelUrl;
                excelLink.download = `asistencia_${nombreArchivo}.xlsx`;
                excelLink.click();
                window.URL.revokeObjectURL(excelUrl);

                showStatus('Archivos descargados: PDF y Excel', 'success');
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function resetDatabase() {
            if (!confirm('‚ö†Ô∏è ¬øResetear TODA la base de datos?\n\nSe cerrar√°n TODAS las sesiones activas y deber√°n volver a ingresar.')) {
                return;
            }

            try {
                showStatus('Realizando reset completo...', 'info');
                
                await apiCall('/voting/admin/reset', {method: 'DELETE'});

                document.getElementById('status-circle').style.background = 'var(--gray-500)';
                document.getElementById('status-text').textContent = 'Estado: Sin verificar';
                document.getElementById('status-text').style.color = 'var(--gray-500)';
                showStatus('Base de datos limpiada completamente', 'success');

                clearTokens();
                adminToken = null;
                voterToken = null;
                currentUser = null;
                isAdmin = false;

                if (updateInterval) {
                    clearInterval(updateInterval);
                    updateInterval = null;
                }

                document.getElementById('access-code').value = '';
                document.getElementById('admin-username').value = '';
                document.getElementById('admin-password').value = '';
                document.getElementById('admin-login').classList.add('hidden');
                document.getElementById('upload-status').innerHTML = '';

                setTimeout(() => {
                    const modals = document.querySelectorAll('div[style*="position: fixed"]');
                    modals.forEach(modal => {
                        if (modal.parentNode === document.body) {
                            document.body.removeChild(modal);
                        }
                    });
                }, 100);

                showScreen('welcome-screen');
                hideStatus();

                return;

            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                window.location.reload();
            }
        }

        function showDeleteCodeModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.7); display: flex; align-items: center; 
                justify-content: center; z-index: 2000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 20px; max-width: 400px; width: 90%; backdrop-filter: blur(20px);">
                    <h3 style="margin-bottom: 1.5rem; color: var(--warning-color); text-align: center;">üö´ Eliminar C√≥digo</h3>
                    
                    <p style="color: var(--gray-700); margin-bottom: 1rem; text-align: center;">
                        Esta acci√≥n eliminar√° el registro de asistencia del c√≥digo especificado.
                    </p>
                    
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">C√≥digo a eliminar:</label>
                    <input type="text" id="delete-code-input" placeholder="1-201" 
                        style="width: 100%; padding: 0.8rem; border: 2px solid var(--gray-300); border-radius: 12px; margin-bottom: 1rem; text-transform: uppercase;">
                    
                    <div style="text-align: center;">
                        <button class="btn btn-danger" onclick="confirmDeleteCode()" style="margin-right: 1rem;">
                            Eliminar
                        </button>
                        <button class="btn" onclick="closeDeleteModal()" style="background: linear-gradient(135deg, var(--gray-500), var(--gray-700));">
                            Cancelar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            setTimeout(() => document.getElementById('delete-code-input').focus(), 100);
            
            window.closeDeleteModal = () => {
                document.body.removeChild(modal);
                delete window.closeDeleteModal;
                delete window.confirmDeleteCode;
            };
            
            window.confirmDeleteCode = async () => {
                const code = document.getElementById('delete-code-input').value.trim().toUpperCase();
                
                if (!code || !/^\d+-\d+$/.test(code)) {
                    showStatus('Formato de c√≥digo inv√°lido. Use formato Torre-Apto (ej: 1-201)', 'error');
                    return;
                }
                
                if (!confirm(`¬øEliminar registro del c√≥digo ${code}?\n\nEsta acci√≥n no se puede deshacer.`)) {
                    return;
                }
                
                try {
                    showStatus('Eliminando registro...', 'info');
                    
                    await apiCall(`/admin/delete-code/${code}`, {
                        method: 'DELETE'
                    });
                    
                    closeDeleteModal();
                    await loadAforoData();
                    showStatus(`C√≥digo ${code} eliminado correctamente`, 'success');
                    
                } catch (error) {
                    showStatus(`Error: ${error.message}`, 'error');
                }
            };
        }

        // ======= FUNCIONES DEL VOTANTE =======
        
        async function showVoterScreen() {
            showScreen('voter-screen');
            initTabSync();
            
            document.getElementById('voter-code').textContent = currentUser.code;
            document.getElementById('voter-name').textContent = `Bienvenido/a, ${currentUser.name}`;
            
            await loadVotingQuestions();
            startAutoRefresh();
            startVotingPolling();
        }

        function startVotingPolling() {
            if (isAdmin) return;
            
            let votingPollInterval = setInterval(async () => {
                if (!document.getElementById('voter-screen').classList.contains('hidden')) {
                    const hasSelectedCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked').length > 0;
                    
                    if (!hasSelectedCheckboxes) {
                        try {
                            await loadVotingQuestions();
                        } catch (error) {
                            console.log('Polling error:', error);
                        }
                    }
                } else {
                    clearInterval(votingPollInterval);
                }
            }, 2000);
        }

        async function loadVotingQuestions() {
            try {
                const questions = await apiCall('/voting/questions/active');
                renderVotingQuestions(questions);
                
                const voterStatus = document.getElementById('voter-status');
                if (voterStatus) {
                    voterStatus.textContent = 'Conectado - Actualizado ' + new Date().toLocaleTimeString();
                }
                
                hideStatus();
            } catch (error) {
                console.error('Error loading voting questions:', error);
                document.getElementById('voting-questions').innerHTML = 
                    '<div class="voting-section"><p style="color: var(--danger-color);">Error cargando votaciones. Intente refrescar la p√°gina.</p></div>';
                showStatus('Error cargando votaciones', 'error');
            }
        }

        async function renderVotingQuestions(questions) {
            const container = document.getElementById('voting-questions');
            
            if (questions.length === 0) {
                container.innerHTML = '<div class="voting-section"><p style="color: var(--gray-700);">No hay votaciones activas en este momento</p></div>';
                return;
            }

            const votedQuestions = await checkUserVotes();

            const sortedQuestions = questions.sort((a, b) => {
                if (a.closed === b.closed) return 0;
                return a.closed ? 1 : -1;
            });

            container.innerHTML = sortedQuestions.map(question => {
                const options = question.options || [{text: 'S√≠'}, {text: 'No'}];
                const hasVoted = votedQuestions.has(question.id);
                const isClosed = question.closed;
                const inputType = question.allow_multiple ? 'checkbox' : 'radio';
                const inputName = `question-${question.id}`;
                
                return `
                    <div class="voting-section">
                        <h3 style="margin-bottom: 1rem; color: var(--dark-color);">${question.text}</h3>
                        ${question.allow_multiple ? 
                            `<p style="color: var(--gray-700); font-size: 0.9rem; margin-bottom: 1rem;">
                                Puede seleccionar hasta ${question.max_selections} opci√≥n${question.max_selections > 1 ? 'es' : ''}
                            </p>` : ''
                        }
                        
                        <div id="question-${question.id}-status">
                            ${hasVoted ? `<p style="color: var(--success-color); font-weight: 500;">‚úÖ Ya votaste en esta pregunta</p>` : ''}
                            ${isClosed ? `<p style="color: var(--danger-color); font-weight: 500; background: rgba(245, 101, 101, 0.1); padding: 0.8rem; border-radius: 12px; border-left: 4px solid var(--danger-color);">
                                üîí Esta votaci√≥n ha sido cerrada. No se pueden registrar m√°s votos.
                            </p>` : ''}
                        </div>
                        
                        <div style="${(hasVoted || isClosed) ? 'display: none;' : ''}" id="voting-options-${question.id}">
                            ${question.allow_multiple ? 
                                `<div style="text-align: left;">
                                    ${options.map((option, index) => `
                                        <label style="display: block; margin: 0.8rem 0; padding: 1rem; background: rgba(255, 255, 255, 0.8); border: 2px solid var(--gray-300); border-radius: 12px; cursor: pointer; transition: all 0.3s ease;">
                                            <input type="checkbox" name="question-${question.id}" value="${option.text}" onchange="checkMaxSelections(${question.id}, ${question.max_selections})" style="margin-right: 0.8rem; transform: scale(1.2);">
                                            ${option.text}
                                        </label>
                                    `).join('')}
                                    <button class="btn" onclick="submitMultipleVote(${question.id})" style="margin-top: 1rem; width: 100%;">Confirmar Selecci√≥n</button>
                                </div>` :
                                `<div style="text-align: center;">
                                    ${options.map((option, index) => {
                                        const isYesNo = options.length === 2 && (option.text === 'S√≠' || option.text === 'No');
                                        const buttonClass = isYesNo ? 
                                            (option.text === 'S√≠' ? 'vote-option yes-option' : 'vote-option no-option') : 
                                            'vote-option';
                                        
                                        return `<div class="${buttonClass}" onclick="submitDirectVote(${question.id}, '${option.text}')">${option.text}</div>`;
                                    }).join('')}
                                </div>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function submitDirectVote(questionId, answer) {
            if (currentUser && currentUser.code === CODIGO_PRUEBA) {
                showStatus(`Voto de prueba registrado: ${answer}`, 'success');
                document.getElementById(`question-${questionId}-status`).innerHTML = 
                    '<p style="color: var(--success-color); font-weight: 500;">‚úÖ Ya votaste en esta pregunta (simulaci√≥n)</p>';
                document.getElementById(`voting-options-${questionId}`).style.display = 'none';
                return;
            }

            try {
                showStatus('Registrando voto...', 'info');
                
                await apiCall('/voting/vote', {
                    method: 'POST',
                    body: JSON.stringify({
                        question_id: questionId,
                        answer: answer
                    })
                });

                await loadVotingQuestions();
                showStatus(`Voto registrado: ${answer}`, 'success');
            } catch (error) {
                if (error.message.includes('Ya has votado')) {
                    showStatus('Ya has votado en esta pregunta', 'error');
                } else {
                    showStatus(`Error: ${error.message}`, 'error');
                }
            }
        }

        function startAutoRefresh() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }

            if (isAdmin) {
                updateInterval = setInterval(async () => {
                    await loadAforoData();
                }, 5000);
            } else {
                updateInterval = setInterval(async () => {
                    const hasSelectedCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked').length > 0;
                    if (!hasSelectedCheckboxes) {
                        await loadVotingQuestions();
                    }
                }, 2000);
            }
        }

        function checkMaxSelections(questionId, maxSelections) {
            const checkboxes = document.querySelectorAll(`input[name="question-${questionId}"]:checked`);
            const allCheckboxes = document.querySelectorAll(`input[name="question-${questionId}"]`);
            
            if (checkboxes.length >= maxSelections) {
                allCheckboxes.forEach(cb => {
                    if (!cb.checked) {
                        cb.disabled = true;
                        cb.parentElement.style.opacity = '0.5';
                    }
                });
            } else {
                allCheckboxes.forEach(cb => {
                    cb.disabled = false;
                    cb.parentElement.style.opacity = '1';
                });
            }
        }

        async function submitMultipleVote(questionId) {
            if (currentUser && currentUser.code === CODIGO_PRUEBA) {
                const checkboxes = document.querySelectorAll(`input[name="question-${questionId}"]:checked`);
                const answers = Array.from(checkboxes).map(cb => cb.value);
                showStatus(`Votos de prueba registrados: ${answers.join(', ')}`, 'success');
                document.getElementById(`question-${questionId}-status`).innerHTML = 
                    '<p style="color: var(--success-color); font-weight: 500;">‚úÖ Ya votaste en esta pregunta (simulaci√≥n)</p>';
                document.getElementById(`voting-options-${questionId}`).style.display = 'none';
                return;
            }

            const checkboxes = document.querySelectorAll(`input[name="question-${questionId}"]:checked`);
            const answers = Array.from(checkboxes).map(cb => cb.value);
            
            if (answers.length === 0) {
                showStatus('Debe seleccionar al menos una opci√≥n', 'error');
                return;
            }
            
            try {
                showStatus('Registrando votos...', 'info');
                console.log('Enviando datos:', { question_id: questionId, answer: answers });
                console.log('URL completa:', `${API_BASE}/voting/vote`);
                console.log('API_BASE actual:', API_BASE);
                await apiCall('/voting/vote', {
                    method: 'POST',
                    body: JSON.stringify({
                        question_id: questionId,
                        answer: answers
                    })
                });

                await loadVotingQuestions();
                showStatus(`Votos registrados: ${answers.join(', ')}`, 'success');
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // ======= SISTEMA DE NOTIFICACIONES =======
        
        function showStatus(message, type = 'info') {
            const panel = document.getElementById('status-panel');
            const content = document.getElementById('status-content');
            
            const colors = {
                success: 'var(--success-color)',
                error: 'var(--danger-color)',
                info: 'var(--info-color)'
            };

            // Agregar borde de color seg√∫n tipo
            const borderColors = {
                success: 'var(--success-color)',
                error: 'var(--danger-color)',
                info: 'var(--info-color)'
            };

            panel.style.borderLeft = `4px solid ${borderColors[type] || borderColors.info}`;
            content.innerHTML = `<span style="color: ${colors[type] || colors.info}; font-weight: 600;">${message}</span>`;
            panel.classList.remove('hidden');

            setTimeout(() => {
                panel.classList.add('hidden');
            }, 4000);
        }

        function hideStatus() {
            document.getElementById('status-panel').classList.add('hidden');
        }

        // ======= EVENT LISTENERS =======
        
        document.getElementById('access-code').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                accessVoting();
            }
        });

        document.getElementById('admin-password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                validateAdmin();
            }
        });

        // ======= INICIALIZACI√ìN =======
        
        window.addEventListener('load', async () => {
            // Intentar restaurar sesi√≥n admin
            const savedAdminToken = getToken('admin');
            if (savedAdminToken) {
                adminToken = savedAdminToken;
                isAdmin = true;
                try {
                    await apiCall('/voting/aforo');
                    showAdminScreen();
                    showStatus('Sesi√≥n de administrador restaurada', 'success');
                } catch (error) {
                    clearTokens();
                    adminToken = null;
                    isAdmin = false;
                    showStatus('Sesi√≥n expirada, ingrese nuevamente', 'info');
                }
            }

            // Intentar restaurar sesi√≥n votante
            const savedVoterToken = getToken('voter');
            if (savedVoterToken && !isAdmin) {
                voterToken = savedVoterToken;
                try {
                    await apiCall('/voting/questions/active');
                    clearTokens();
                    voterToken = null;
                    showStatus('Para votar, ingrese su c√≥digo nuevamente', 'info');
                } catch (error) {
                    clearTokens();
                    voterToken = null;
                }
            }

            if (!isAdmin && !voterToken) {
                showStatus('Sistema iniciado - Ingrese sus credenciales', 'success');
            }

            // Agregar efecto ripple a todos los botones
            document.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    const ripple = document.createElement('span');
                    ripple.style.cssText = `
                        position: absolute;
                        border-radius: 50%;
                        background: rgba(255, 255, 255, 0.6);
                        transform: scale(0);
                        animation: ripple 0.6s linear;
                        pointer-events: none;
                    `;
                    
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    ripple.style.width = ripple.style.height = size + 'px';
                    ripple.style.left = (e.clientX - rect.left - size / 2) + 'px';
                    ripple.style.top = (e.clientY - rect.top - size / 2) + 'px';
                    
                    this.appendChild(ripple);
                    
                    setTimeout(() => ripple.remove(), 600);
                });
            });

            // Validaci√≥n en tiempo real del c√≥digo
            document.getElementById('access-code').addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
                
                const value = e.target.value;
                const isValid = /^\d*-?\d*$/.test(value);
                
                if (value && !isValid) {
                    e.target.style.borderColor = 'var(--danger-color)';
                } else {
                    e.target.style.borderColor = 'var(--gray-300)';
                }
            });
        });

        // Animaci√≥n CSS para el efecto ripple
        const style = document.createElement('style');
        style.textContent = `
            @keyframes ripple {
                to {
                    transform: scale(4);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // Limpiar al cerrar ventana
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>